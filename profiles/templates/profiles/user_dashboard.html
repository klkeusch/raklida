{% extends "blog/base.html" %}
{% load static %}
{% comment %}
{% load bootstrap4 %}
{% block extrahead %}
    {{ form.media }}
{% endblock %}
{% load crispy_forms_tags %}{% endcomment %}
{% block content %}

<div class="landing bg-dark">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-sm-12 col-lg-8 text-center">
                <h1 class="text-white font-weight-bold display-5 mt-5">Benutzer-Dashboard</h1>
            </div>

            {% csrf_token %}

            <div class="col-md-6">
                <div class="form-group text-center mt-3">
                <label for="inputStatus" class="text-white">Geräteauswahl</label>
{#                    {% csrf_token %}#}
{#                    <form id="deviceform" method="get" action="{% url 'show_user_device' %}">#}
{#                        {{ device_list }}#}
{#                        <input type="submit" value="Senden">#}
{#                    </form>#}

                    <form id="deviceform" action="{% url 'show_user_device' %}" method="GET">
                        {% csrf_token %}
                        {{ device_list }}
                        <input type="submit" value="Wählen" />
                    </form>

{#                    <label for="inputStatus" class="text-white">Geräteauswahl</label>#}
{% comment %}                    <select id="device-display-name" class="form-control-sm custom-select">
                        <option selected disabled>Bitte Gerät auswählen</option>
                        {% for item in query_results %}
                            <option value="{{ item.id }}">{{ item.display_name }}</option>
                        {% endfor %}
                    </select>{% endcomment %}
                </div>
            </div>


        </div>
    </div>
</div>


<div class="container bg-light mt-n5 p-5 rounded">
    <div class="row border-bottom">
        <div class="container text-center">
            {% if current_device_display_name %}
            <h3>Gerät: {{ query_current_device_display_name|join:" " }}</h3>
                <p>Aktualisiert: {{ query_current_last_update }}</p>
            <div class="row bg-secondary border-bottom align-items-center justify-content-center">
                <div class="col border-right">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">Temperatur [°C]</p>
                </div>
                <div class="col border-right">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">Luftfeuchtigkeit [%]</p>
                </div>
                <div class="col">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">CO2-Wert [ppm]</p>
                </div>
            </div>
            <div class="row align-items-center justify-content-center">
                <div class="col border-right">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_ambient_temperature|floatformat:2 }}</h1><!--current_ambient_temperature |default_if_none:" "|cut:"["|cut:"]"|floatformat:1 }}</h1>-->
                </div>
                <div class="col border-right">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_relative_humidity|default_if_none:" "|floatformat:2 }}</h1>
                </div>
                <div class="col">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_co2_concentration|default_if_none:" "|floatformat:2 }}</h1>
                </div>
            </div>
        </div>
    </div>
    <div class="row border-bottom">
        <div class="container text-center">
            <div class="row bg-secondary border-bottom align-items-center justify-content-center">
                <div class="col border-right">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">Luftdruck [mbar]</p>
                </div>
                <div class="col border-right">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">Feinstaubkonzentration [&microg/m<sup>3</sup>]</p>
                </div>
                <div class="col">
                    <p class="text-white font-weight-bold display-8 mb-3 mt-3">Luftqualität</p>
                </div>
            </div>
            <div class="row align-items-center justify-content-center">
                <div class="col border-right">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_barometric_pressure|default_if_none:" "|floatformat:2 }}</h1>
                </div>
                <div class="col border-right">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_finedust_concentration|default_if_none:" " }}</h1>
                </div>
                <div class="col">
                    <h1 class="text-dark font-weight-bold display-12 mb-3 mt-3">{{ query_current_air_quality|default_if_none:" " }}</h1>
                    <!-- mit if-Abfrage fuer die Zahlenwerte gut mittel schlecht-->
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container bg-light mt-n5 p-5 rounded">
    <div class="row">
        <div class="col-12">
            <h1>Messwertverlauf</h1>
        </div>
        <div class="col-12">

            {% csrf_token %}
            <div class="col-md-12">
                <div class="form-group text-left">
                    <label for="inputStatus" class="text-dark">Messwertauswahl</label>
                    <select id="question-subject" class="form-control-sm custom-select">
                        <option selected disabled>Bitte wählen...</option>
                        {% for message in notifications %}
                            <!--<option value="{{ message.id }}">{{ message.sender }}</option>-->
                            <option value="{{ message.id }}">Temperatur</option>
                            <option value="{{ message.id }}">Luftfeuchtigkeit</option>
                            <option value="{{ message.id }}">CO2-Wert</option>
                            <option value="{{ message.id }}">Luftdruck</option>
                            <option value="{{ message.id }}">Feinstaubkonzentration</option>
                            <option value="{{ message.id }}">Luftqualität</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

        {{ data|json_script:"mydata" }}
{{ labels|json_script:"mylabels" }}

            {% block javascript %}
                <canvas id="chart"></canvas>
                <script  type="text/javascript" id="testl">
                    let ctx = document.getElementById('chart');
                    let formData = new FormData(document.getElementById('deviceform'));
                    //var myLabels = "{{ labels|escapejs|safe }}"; //document.getElementById("myLabels").textContent;
                    //var myData =JSON.parse("{{ data|escapejs }}"); //"{{ data|escapejs|safe }}"; //document.getElementById("myData").textContent;
                    const mydata = JSON.parse(document.getElementById('mydata').textContent);
                    const mylabels = JSON.parse(document.getElementById('mylabels').textContent);

                    $.ajax({
                        url: '/line_chart/',
                        success: function(){ //success: function(formData){
                        new Chart(ctx, {
                        type: 'line',
                        data: { //response.data,
                            labels: mylabels,//"{{ labels|escapejs }}", //myLabels,//formData.labels,
                                datasets: [{
                                    label: 'Temperatur [°C]',
                                    backgroundColor:"white",
                                    borderColor: "red",
                                    fill: false,
                                    lineTension: 0,
                                    radius: 2,
                                    data: mydata,//'{{ data|escapejs }}',//formData.data
                                  }]
                                },
                       options: {
                            locale: 'de-DE',
                            responsive: true,
                            scales: {
                                x: {
                                    type: "time",
                                    time: {
                                        tooltipFormat: 'DD.MM.YY, HH:mm',
                                        displayFormats: {
                                            'millisecond': 'HH:mm:ss.SSS',
                                            'second': 'HH:mm:ss',
                                            'minute': 'HH:mm',
                                            'hour': 'HH:mm',
                                            'day': 'D',
                                            'week': 'DD MMM',
                                            'month': 'DD MMM',
                                            'quarter': 'DD MMM',
                                            'year': 'DD MMM',
                                        },
                                    {#      unitStepSize: 1,#}
                                    {#      unit: 'day',#}
                                    },
                                    gridLines : {
                                        display: false,
                                    },
                                    ticks:{
                                        display: true,
                                        autoSkip: true,
                                        maxTicksLimit: 24.1
                                    },
                                },
                                y: {

                                    {#ticks: {#}
                                    {#    display: true,#}
                                    {#    autoskip: true,}#}

                                }
                            },
                        }
                              });
                            }
                          });
                </script>
            {% endblock javascript %}

        </div>
    </div>
</div>
            {% endif %}
<div class="container bg-light mt-n5 p-5 rounded">
    <div class="row">
        <div class="col-12 border-bottom mb-3">
            <h1>Aktuelle Meldungen</h1>
        </div>
        <div class="col-12 mb-3">

            <p><a class="btn btn-md btn-primary"
                  href="{% url 'message_create' %}">Neue Meldung verfassen</a></p>

            {% if notifications.count > 0 %}
                {% for message in notifications|dictsortreversed:"sent_at" %}
                    <div class="row blog mb-5">
                        <div class="col-lg-2 col-sm-12 text-center">
                            Empfänger:<a class="mugshot-container mb-1"
                                         href="{% url 'profile' message.recipient.pk %}">
                            <div class="mugshot-img mb-2"
                                 style="background-image:url({{ message.recipient.profile.image.url }})"></div>
                            <span>{{ message.recipient.first_name }} {{ message.recipient.last_name }}</span>
                        </a>
                        </div>
                        <div class="col-lg-10 col-sm-12">
                            <div class="blog-information">
                                <p class="text-muted">Gesendet am {{ message.sent_at|date:"d.m.Y" }}
                                    um {{ message.sent_at|date:"H:i" }}</p>
                                <p>{{ message.content }}</p>
                                {#                                    <p class="text-muted">Gesendet am {{ message.sent_at|date:"d.m.Y" }}#}
                                {#                                        um {{ message.sent_at|date:"H:i" }}</p>#}
                                <p class="text-bold">Vorfall am {{ message.incident_date|date:"d.m.Y" }}
                                    um {{ message.incident_date|date:"H:i" }}</p>
                                <div class="update-edit">
                                    {% if request.user.is_authenticated and request.user == message.sender %}
                                        <a class="btn btn-sm btn-info"
                                           href="{% url 'message_update' message.pk %}">Bearbeiten</a>
                                        <a class="btn btn-sm btn-danger"
                                           href="{% url 'message_delete' message.pk %}">Löschen</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {#                        <a class="btn btn-md btn-primary"#}
                {#                           href="{% url 'message_create' %}">Neue Meldung verfassen</a>#}
                </div>
                </div>
            {% else %}
                <div class=" ">
                    <h2 class="text-muted text-center">Hier wurde leider noch keine Nachricht verfasst!
                        ¯\_(ツ)_/¯<br/><br/></h2>
                </div>
            {% endif %}
</div>
</div>
</div>

<h1>Device details</h1>
    <table>

{% comment %}

        {% for item in query_results %}
            {% if request.user.is_authenticated and request.user == query_results.assigned_user %}
            <tr>
                <td>{{ item.display_name }}</td>
                <td>{{ item.mac_address }}</td>
            </tr>
            {% endif %}
        {% endfor %}
    {% endcomment %}
        <tr>
            <th>Datapoint</th>
            <th>MQTT-Node</th>
            <th>Device</th>
            <th>Display name</th>
            <th>Curr. val. int</th>
            <th>Curr. val. double</th>
            <th>Curr. val. string</th>
            <th>Last update</th>
            <th>Store historic data</th>
        </tr>
        {% for item in query_current_ambient_temperature_graph_data %}

            <tr>
                <td>{{ item }}</td>
{#                <td>{{ item.mqtt_node }}</td>#}
{#                <td>{{ item.datapoint.device }}</td>#}
{#                <td>{{ item.datapoint.display_name }}</td>#}
{#                <td>{{ item.datapoint.current_value_integer }}</td>#}
{#                <td>{{ item.datapoint.current_value_double }}</td>#}
{#                <td>{{ item.datapoint.current_value_string }}</td>#}
{#                <td>{{ item.datapoint.last_update }}</td>#}
{#                <td>{{ item.datapoint.store_historic_data }}</td>#}
            </tr>
        {% endfor %}
    </table>

    <p>{{ query_current_temperature }}</p>

</div>
</div>
 </div>

{% endblock content %}